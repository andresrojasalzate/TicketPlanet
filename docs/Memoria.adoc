= TICKETPLANET 
Adria Bernabeu, Salma Picazo, Andres Rojas

:toc-title: ÍNDICE
:figure-caption: Figura
:table-caption: Taula
:example-caption: Exemple
:doctype: book
:encoding: utf-8
:lang: es
:toc: left
:toclevels: 5
:sectnums:
:icons: font   
:numbered:

== INTRODUCCIÓN

*TicketPlanet*

image::Images/Logo.png[Logo principal, width=10%]

*Miembros*  

- Adria Bernabeu

- Salma Picazo

- Andres Rojas

=== Objetivo de la aplicación

TicketPlanet facilita a los usuarios la compra de entradas de diferentes tipos de eventos, gracias a su plataforma intuitiva y segura.


== DISEÑO

=== Base de datos

==== Diagrama de clases

[plantuml,,png]
----

class Assistant {
        nameAssistant: string
        dniAssistant: string
        phoneAssistant: string
        compra_id: integer
        ticket_id: integer
        
        + compra() : Compra
        + ticket() : Ticket
    }
    
    class Category {
        id: int
        name: string
        
        + events() : List<Event>    
    }
    
    class Compra {
        id: int
        emailPurchaser: string
        namePurchaser: string
        dniPurchaser: string
        phonePurchaser: string
        pdfTickets: string
        session_id: integer
        
        + session() : Session
    }
    
    class Event {
        id: int
        name: string
        address: string
        city: string
        name_site: string
        image: string
        description: string
        finishDate: date
        finishTime: time
        visible: boolean
        capacity: integer
        category_id: integer
        user_id: integer
        
        + category() : Category
        + user() : User
        + sessions() : List<Session>
        + valoraciones() : List<Valoracion>
    }
    
    class Session {
        id: int
        date: date
        time: time
        maxCapacity: integer
        ticketsSold: integer
        open: boolean
        event_id: integer
        
         + tickets() : List<Ticket>
    }
    
    class Ticket {
        id: int
        name: string
        quantity: integer
        price: float
        sold_tickets: integer
        nominal: boolean
        session_id: integer
        
        + session() : Session
    }
    
    class User {
        id: int
        name: string
        email: string
        password: string
        reset_token: string
        reset_token_created_at: datetime
    }
    
    class Valoracion {
        id: int
        nombre: string
        caraSeleccionada: string
        puntuacionSeleccionada: integer
        tituloComentario: string
        comentario: string
        event_id: integer
        
        + event() : Event
    }
    
    Assistant "1" -- "0..1" Compra
    Assistant "1" -- "0..1" Ticket
    
    Compra "1" -- "0..1" Session
    
    Event "0..n" -- "1" Category
    Event "1" -- "1" User
    Event "1" -- "0..n" Session
    Event "1" -- "0..n" Valoracion
    
    Session "1" -- "0..n" Ticket
----

==== Diagrama E-R:
image::Images/diagrama.png[Logo principal, width=50%]

=== Interfícies
    
==== Sketching

==== Figma
Link a las interfícies de Figma https://www.figma.com/file/V47MqQzp5biMSzsQ5m7gZU/Mockups?type=design&node-id=0-1&mode=design&t=IMIfO6zr6hBVFlYG-0[aquí]. 

=== Guía de estilos
Link a la guía de estilos de Figma https://www.figma.com/file/7RISOKUOjvDXdzufahisrv/Gu%C3%ADa-de-estilos?type=design&node-id=0%3A1&mode=design&t=QgHjfUcq2g73B829-1[aquí]. 

== MANUAL DE INSTALACIÓN SERVER

=== Paso 1: Instalar Apache

Instala Apache en tu servidor Debian

```bash
sudo apt update
sudo apt install apache2
```

Habilita el módulo de Apache necesario para ejecutar aplicaciones PHP.

```bash
sudo a2enmod php8.2
sudo systemctl restart apache2
```

=== Paso 2: Instalar PHP y Extensiones Necesarias

```bash
sudo apt install php7.4 sudo apt install php8.2-curl php8.2-dom php8.2-mbstring php8.2-xml php8.2-pgsql zip unzip
```

=== Paso 3: Descargar proyecto laravel

```bash
cd /var/www/
git pull https://git.copernic.cat/abernabeu/gr3-bernabeu-rojas-picazo.git
```
=== Paso 4: Configurar conexión a base de datos

```bash
cd /var/www/gr3-bernabeu-rojas-picazo/ticketplanet
cp .env.example .env
```
Modficar el archivo .env 

```bash
DB_CONNECTION=pgsql
DB_HOST=127.0.0.1
DB_PORT=5432
DB_DATABASE=ticketplanet
DB_USERNAME=usuario
DB_PASSWORD=1234
```

=== Paso 6: Instalar Dependencias de Composer

Instala las dependencias de Composer para tu proyecto Laravel.

```bash
cd /var/www/gr3-bernabeu-rojas-picazo/ticketplanet
composer install --no-dev
```

=== Paso 7: Generar app key

```bash
cd /var/www/gr3-bernabeu-rojas-picazo/ticketplanet
php artisan key:generate
```

=== Paso 8: Dar permisos
```bash
cd /var/www/gr3-bernabeu-rojas-picazo/ticketplanet
chown -R www-data storage
chown -R www-data bootstrap/cache
```
```bash
chmod -R 755 storage
chmod -R 755 bootstrap/cache
```

=== Paso 9: Configurar Virtual Host de Apache

Crea un archivo de configuración de Virtual Host para tu proyecto Laravel

```bash
sudo nano /etc/apache2/sites-available/laravel.conf
```
Pon el siguiente contenido:

```bash
<VirtualHost *:80>
    ServerName ticket.com
    DocumentRoot /var/www/gr3-bernabeu-rojas-picazo/ticketplanet/public

    <Directory /var/www/gr3-bernabeu-rojas-picazo/ticketplanet/public>
        Options Indexes FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>

    ErrorLog ${APACHE_LOG_DIR}/demo-error.log
    CustomLog ${APACHE_LOG_DIR}/demo-access.log combined
</VirtualHost>
```

Guarda y cierra el archivo. Luego, habilita el Virtual Host y reinicia Apache.

```bash
sudo a2ensite laravel
sudo systemctl restart apache2
```
=== Paso 10: Activar Docker
```bash
cd /var/www/gr3-bernabeu-rojas-picazo/docker/server
sudo docker compose up -d
```

=== Paso 11: Crear base de datos

```bash
cd /var/www/gr3-bernabeu-rojas-picazo/ticketplante
```

Ejecutamos el siguiente comando para crear base de datos.

```bash
sudo php artisan migrate
```

=== Paso 12: Instalar unaccent en Postgresql

Ejecutamos el siguiente comando para entrar a la terminal de postgresql 

```bash
sudo docker exec -it pg_container psql -U usuario  ticketplanet
```

Una vez en la terminal de postgresql ejecutamos el siguiente comando

```bash
CREATE EXTENSION unaccent;
```

== MANUAL DE INSTALACIÓN LOCAL

=== Paso 1: Descargar el proyecto de GitLab

```bash
git pull https://git.copernic.cat/abernabeu/gr3-bernabeu-rojas-picazo.git
```
=== Paso 2: Configurar docker con la base de datos del proyecto de la API

Accedemos a la carpeta api-imagenes y ejecutamos el siguiente comando:
```bash
cd api-imagenes
docker-compose up -d
```

=== Paso 3: Instalar composer en el proyecto de la api

```bash
cd api-imagenes/api-rest/
composer install
```

=== Paso 4: Configurar .env del proyecto api
Creamos el archivo .env

```bash
cd api-imagenes/api-rest/
cp .env.example .env
```
Editamos el archivo para congiurar el acceso a la base de datos en el proyecto

```bash
DB_CONNECTION=pgsql
DB_HOST=127.0.0.1
DB_PORT=9001
DB_DATABASE=api-rest
DB_USERNAME=usuario
DB_PASSWORD=1234
```
Añadimos un ultimo parámetro para configurar el puerto del proyecto en el 9000

```bash
SERVER_PORT=9000
```
=== Paso 4: Generar app_key para el proyecto de la api 

```bash
cd api-imagenes/api-rest/
php artisan key:generate
```
=== Paso 5: Hacer la migracion del proyecto 

```bash
cd api-imagenes/api-rest/
php artisan migrate
```
=== Paso 6: Configurar docker con la base de datos del proyecto de la app

Accedemos a la carpeta docker/dev y ejecutamos el siguiente comando:
```bash
cd docker/dev
docker-compose up -d
```

=== Paso 7: Instalar composer en el proyecto de la app

```bash
cd ticketplanet/
composer install
```

=== Paso 8: Configurar .env del proyecto app
Creamos el archivo .env

```bash
cd ticketplanet/
cp .env.example .env
```
Editamos el archivo para congiurar el acceso a la base de datos en el proyecto

```bash
DB_CONNECTION=pgsql
DB_HOST=127.0.0.1
DB_PORT=5432
DB_DATABASE=ticketplanet
DB_USERNAME=usuario
DB_PASSWORD=1234
```
Añadimos uns parámetros de configuración necesarios en el .env

```bash
PAGINATION_LIMIT=10
EVENT_LIMIT_HOME=6
PASARELA_PAGAMENT = true
API_LOCAL= true
```
=== Paso 9: Generar app_key para el proyecto de la app 

```bash
cd ticketplanet/
php artisan key:generate
```
=== Paso 10: Hacer la migracion del proyecto 

```bash
cd ticketplanet/
php artisan migrate
```

=== Paso 11: Instalar unaccent en Postgresql

Ejecutamos el siguiente comando para entrar a la terminal de postgresql 

```bash
sudo docker exec -it pg_container psql -U usuario  ticketplanet
```

Una vez en la terminal de postgresql ejecutamos el siguiente comando

```bash
CREATE EXTENSION unaccent;
```

=== Paso 12: Generar un token para acceder a la api desde la app
Accedemos al proyecto y ejecutamos el proyecto "php artisan db:seed"

```bash
cd api-imagenes/api-rest/
php artisan db:seed
```
El comando debolvera un token. Este token lo deberdemos poner en el archivo .env del proyecto ticketplanet de la siguiene manera:

```bash
cd ticketplanet/
```
archivo .env:
```bash
API_KEY="a9yKqIWD4hqiLdBA0sat7ogQOVIwiRGYsu51XNEOa3a582a5"
```

=== Paso 13: Activar el proyecto

Para activiar el proyecto primero activamos la API

```bash
cd api-imagenes/api-rest/
php artisan serve
```

Una vez activamos la API activamos activamos la app

```bash
cd ticketplanet/
php artisan serve
```
Y en el navegador buscamos 127.0.0.1:8000

== CONCLUSIÓN   

=== Líneas futuras

=== Webgrafia

=== Presentación
